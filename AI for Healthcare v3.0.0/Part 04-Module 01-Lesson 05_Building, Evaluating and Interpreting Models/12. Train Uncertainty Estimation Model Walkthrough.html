<!-- udacity2.0 -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Train Uncertainty Estimation Model Walkthrough</title>
  <link rel="stylesheet" href="../assets/css/bootstrap.min.css">
  <link rel="stylesheet" href="../assets/css/plyr.css">
  <link rel="stylesheet" href="../assets/css/katex.min.css">
  <link rel="stylesheet" href="../assets/css/jquery.mCustomScrollbar.min.css">
  <link rel="stylesheet" href="../assets/css/styles.css">
  <link rel="shortcut icon" type="image/png" href="../assets/img/udacimak.png" />
</head>

<body>
  <div class="wrapper">
    <nav id="sidebar">
  <div class="sidebar-header">
    <h3>Building, Evaluating and Interpreting Models</h3>
  </div>

  <ul class="sidebar-list list-unstyled CTAs">
    <li>
      <a href="../index.html" class="article">Back to Home</a>
    </li>
  </ul>

  <ul class="sidebar-list list-unstyled components">
    <li class="">
      <a href="01. Building, Evaluating &amp; Interpreting Models Overview.html">01. Building, Evaluating &amp; Interpreting Models Overview</a>
    </li>
    <li class="">
      <a href="02. Tensorflow Regression Model with DenseFeatures.html">02. Tensorflow Regression Model with DenseFeatures</a>
    </li>
    <li class="">
      <a href="03. TF DenseFeatures Walkthrough.html">03. TF DenseFeatures Walkthrough</a>
    </li>
    <li class="">
      <a href="04. Common EHR Model Evaluation Metrics.html">04. Common EHR Model Evaluation Metrics</a>
    </li>
    <li class="">
      <a href="05. Common EHR Model Evaluation Metrics Exercise.html">05. Common EHR Model Evaluation Metrics Exercise</a>
    </li>
    <li class="">
      <a href="06. Common EHR Model Evaluation Metrics Solution.html">06. Common EHR Model Evaluation Metrics Solution</a>
    </li>
    <li class="">
      <a href="07. Demographic Bias Analysis.html">07. Demographic Bias Analysis</a>
    </li>
    <li class="">
      <a href="08. Demographic Bias Analysis Walkthrough.html">08. Demographic Bias Analysis Walkthrough</a>
    </li>
    <li class="">
      <a href="09. Demographic Bias Analysis Exercise.html">09. Demographic Bias Analysis Exercise</a>
    </li>
    <li class="">
      <a href="10. Demographic Bias Analysis Solution.html">10. Demographic Bias Analysis Solution</a>
    </li>
    <li class="">
      <a href="11. Uncertainty Estimation.html">11. Uncertainty Estimation</a>
    </li>
    <li class="">
      <a href="12. Train Uncertainty Estimation Model Walkthrough.html">12. Train Uncertainty Estimation Model Walkthrough</a>
    </li>
    <li class="">
      <a href="13. Uncertainty Estimation Exercise.html">13. Uncertainty Estimation Exercise</a>
    </li>
    <li class="">
      <a href="14. Uncertainty Estimation Solution.html">14. Uncertainty Estimation Solution</a>
    </li>
    <li class="">
      <a href="15. Model Interpretability with Shapley Values.html">15. Model Interpretability with Shapley Values</a>
    </li>
    <li class="">
      <a href="16. Building Models Recap.html">16. Building Models Recap</a>
    </li>
    <li class="">
      <a href="17. AI and EHR Recap.html">17. AI and EHR Recap</a>
    </li>
  </ul>

  <ul class="sidebar-list list-unstyled CTAs">
    <li>
      <a href="../index.html" class="article">Back to Home</a>
    </li>
  </ul>
</nav>

    <div id="content">
      <header class="container-fluild header">
        <div class="container">
          <div class="row">
            <div class="col-12">
              <div class="align-items-middle">
                <button type="button" id="sidebarCollapse" class="btn btn-toggle-sidebar">
                  <div></div>
                  <div></div>
                  <div></div>
                </button>

                <h1 style="display: inline-block">12. Train Uncertainty Estimation Model Walkthrough</h1>
              </div>
            </div>
          </div>
        </div>
      </header>

      <main class="container">
        <div class="row">
          <div class="col-12">
            <div class="ud-atom">
  <h3></h3>
  <div>
  <h2 id="train-uncertainty-estimation-model-walkthrough">Train Uncertainty Estimation Model Walkthrough</h2>
</div>

</div>
<div class="divider"></div><div class="ud-atom">
  <h3><p>ND320 AIHCND C01 L04 A10 Train Uncertainty Estimation Model With TF Probability</p></h3>
  <video controls>
  <source src="12. ND320 AIHCND C01 L04 A10 Train Uncertainty Estimation Model With TF Probability-8GQktML4aU4.mp4" type="video/mp4">

  <track default="true" kind="subtitles" srclang="en" src="12. ND320 AIHCND C01 L04 A10 Train Uncertainty Estimation Model With TF Probability-8GQktML4aU4.en.vtt" label="en">
</video>


</div>
<div class="divider"></div><div class="ud-atom">
  <h3></h3>
  <div>
  <p><em>Typo: should say "Government Aid" at about 0:40.</em></p>
</div>

</div>
<div class="divider"></div><div class="ud-atom">
  <h3></h3>
  <div>
  <h2 id="types-of-uncertainty">Types of Uncertainty</h2>
<ul>
<li>Aleatoric: <ul>
<li>Statistical Uncertainty - a natural, random process</li>
<li>Known Unknowns</li></ul></li>
</ul>
<p>Aleatoric uncertainty is otherwise known as statistical uncertainty and is known unknowns. This type of uncertainty is inherent, and just a part of the stochasticity that naturally exists. An example is rolling a dice, which will have an element of randomness always to it.</p>
<ul>
<li>Epistemic:<ul>
<li>Systematic Uncertainty - lack of measurement, knowledge</li>
<li>Unknown Unknowns</li></ul></li>
</ul>
<p>Epistemic uncertainty is also known as systemic uncertainty and is unknown unknowns. This type of uncertainty can be improved by adding parameters/features that might measure something in more detail or provide more knowledge.</p>
<h4 id="additional-resources">Additional Resources</h4>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Uncertainty_quantification" rel="noopener noreferrer" target="_blank">Uncertainty</a></li>
</ul>
</div>

</div>
<div class="divider"></div><div class="ud-atom">
  <h3></h3>
  <div>
  <h2 id="key-points">Key Points</h2>
<h3 id="building-a-basic-uncertainty-estimation-model-with-tensorflow-probability">Building a Basic Uncertainty Estimation Model with Tensorflow Probability</h3>
<ul>
<li>Using the MPG model from earlier, create uncertainty estimation model with TF Probability.</li>
<li>In particular, we will focus on building a model that accounts for Aleatoric Uncertainty.</li>
</ul>
<p>NOTE: Before we go into the walkthrough I want to note that  TF Probability is not a v1 yet and documentation and standard patterns are evolving. That being said I wanted to expose you to a tool that might be good to have on your radar and this library can abstract away some of the challenging math behind the scenes.</p>
<h3 id="model-with-aleatoric-uncertainty">Model with Aleatoric Uncertainty</h3>
<ul>
<li>Known Unknowns</li>
<li>2 Main Model Changes<ul>
<li>Add a second unit to the last dense layer before passing it to Tensorflow Probability layer to model for the predictor y and the <a href="https://en.wikipedia.org/wiki/Heteroscedasticity" rel="noopener noreferrer" target="_blank">heteroscedasticity</a> or unequal scattering of data</li></ul></li>
</ul>
<pre><code>        tf.keras.layers.Dense(1 + 1)</code></pre>
<ul>
<li><p>DistributionLambda is a special Keras layer that uses a Python lambda to construct a distribution based on the layer inputs and the output of the final layer of the model is passed into the loss function. This model will return a distribution for both mean and standard deviation. The 'loc' argument is the mean and is sampled across the normal distribution as well as the 'scale' argument which is the standard deviation and in this case, is a slightly increasing with a positive slope.   Important to note here is that we have prior knowledge that the relationship between the label and data is linear. However, for a more dynamic, flexible approach you can use the <a href="https://www.tensorflow.org/probability/api_docs/python/tfp/distributions/VariationalGaussianProcess" rel="noopener noreferrer" target="_blank">VariationalGaussianProcess  Layer</a>. This is beyond the scope of this course but as mentioned can add more flexibility.<br />
```        <br />
tfp.layers.DistributionLambda(  <br />
        lambda t:tfp.distributions.Normal(<br />
            loc=t[…, :1],<br />
            scale=1e-3 + tf.math.softplus(0.1 * t[…,1:])</p>
<pre><code>    )</code></pre></li>
</ul>
<pre><code>- We can use different loss functions such as mean squared error(MSE) or negloglik. Note that if we decide to use the standard MSE metric that the scale or standard deviation will be fixed. Below is code from the regression tutorial for using negative log-likelihood loss, which through minimization is a way to maximize the probability of the continuous labels. </code></pre>
<pre><code>negloglik = lambda y, rv_y: -rv_y.log_prob(y)
model.compile(optimizer='adam', loss=negloglik, metrics=[loss_metric])</code></pre>
<pre><code>- Extracting the mean and standard deviations for each prediction by passing the test dataset to the probability model. Then, we can call mean() or stddev() to extract these tensors.</code></pre>
<p>yhat = prob_model(x_tst)<br />
m = yhat.mean()<br />
s = yhat.stddev()</p>
<pre><code>### Model with Epistemic Uncertainty
- Unknown Unknowns 
- Add [Tensorflow Probability DenseVariational Layer](https://www.tensorflow.org/probability/api_docs/python/tfp/layers/DenseVariational) with prior and posterior functions. Below are examples adapted from the [Tensorflow Probability Regression tutorial notebook](https://github.com/tensorflow/probability/blob/master/tensorflow_probability/examples/jupyter_notebooks/Probabilistic_Layers_Regression.ipynb).     </code></pre>
<p>def posterior_mean_field(kernel_size, bias_size=0, dtype=None):<br />
    n = kernel_size + bias_size<br />
    c = np.log(np.expm1(1.))<br />
    return tf.keras.Sequential([<br />
        tfp.layers.VariableLayer(2*n, dtype=dtype),<br />
        tfp.layers.DistributionLambda(lambda t: tfp.distributions.Independent(<br />
            tfp.distributions.Normal(loc=t[…, :n],<br />
                                     scale=1e-5 + tf.nn.softplus(c + t[…, n:])),<br />
            reinterpreted_batch_ndims=1)),<br />
    ])<br />
def prior_trainable(kernel_size, bias_size=0, dtype=None):<br />
    n = kernel_size + bias_size<br />
    return tf.keras.Sequential([<br />
        tfp.layers.VariableLayer(n, dtype=dtype),<br />
        tfp.layers.DistributionLambda(lambda t: tfp.distributions.Independent(<br />
            tfp.distributions.Normal(loc=t, scale=1),<br />
            reinterpreted_batch_ndims=1)),<br />
    ])</p>
<pre><code>- Here is how the 'posterior_mean_field' and 'prior_trainable' functions are added as arguments to the DenseVariational layer that precedes the DistributionLambda layer we covered earlier.</code></pre>
<p>tf.keras.layers.Dense(75, activation='relu'),<br />
           tfp.layers.DenseVariational(1+1, posterior_mean_field, prior_trainable),        <br />
        tfp.layers.DistributionLambda( ….<br />
```</p>
<h3 id="additional-resources">Additional Resources</h3>
<ul>
<li><a href="https://blog.tensorflow.org/2019/03/regression-with-probabilistic-layers-in.html" rel="noopener noreferrer" target="_blank">Tensorflow Regression with Probabilistic Layers Tutorial</a></li>
</ul>
</div>

</div>
<div class="divider"></div><div class="ud-atom">
  <h3></h3>
  <div class="jumbotron">
  <h3>Code</h3>

  <p class="lead">If you need a code on the <a href="https://github.com/udacity"
    target="_blank">https://github.com/udacity</a>. </p>

  </ul>
</div>

</div>
<div class="divider"></div><div class="ud-atom">
  <h3><p>Aleatoric Quiz</p></h3>
  <div>
  <form>
    <fieldset>
      <legend><p>Which of the following are true about aleatoric uncertainty?</p></legend>
    </fieldset>

    <div>
      <input type="checkbox" value="a1587285483284" name="1015003" id="a1587285483284">
      <label for="a1587285483284"><p>Flipping a coin with heads or tails is an example of this type of uncertainty.</p></label>
    </div>
    <div>
      <input type="checkbox" value="a1587285531629" name="1015003" id="a1587285531629">
      <label for="a1587285531629"><p>Adding more features can reduce uncertainty</p></label>
    </div>
    <div>
      <input type="checkbox" value="a1587285532840" name="1015003" id="a1587285532840">
      <label for="a1587285532840"><p>It accounts for some natural, randomness in the process.</p></label>
    </div>
    <div>
      <input type="checkbox" value="a1587285536470" name="1015003" id="a1587285536470">
      <label for="a1587285536470"><p>Unknown unknown</p></label>
    </div>
  </form>

  <details>
    <summary><strong>SOLUTION:</strong></summary>
    <ul>
      <li>Flipping a coin with heads or tails is an example of this type of uncertainty.</li>
      <li>It accounts for some natural, randomness in the process.</li>
  </ul>
  </details>
</div>

</div>
<div class="divider"></div><div class="ud-atom">
  <h3></h3>
  <div>
  <form>
    <fieldset>
      <legend><p>How many units need to be added to the layer before the DistributionLambda layer?</p></legend>
    </fieldset>

      <div>
        <input type="radio" value="a1587285914919" name="1015005" id="a1587285914919">
        <label for="a1587285914919"><p>1</p></label>
      </div>
      <div>
        <input type="radio" value="a1587285964786" name="1015005" id="a1587285964786">
        <label for="a1587285964786"><p>2</p></label>
      </div>
      <div>
        <input type="radio" value="a1587285965896" name="1015005" id="a1587285965896">
        <label for="a1587285965896"><p>3</p></label>
      </div>
      <div>
        <input type="radio" value="a1587285967806" name="1015005" id="a1587285967806">
        <label for="a1587285967806"><p>Does not matter</p></label>
      </div>
  </form>

  <details>
    <summary><strong>SOLUTION:</strong></summary>
    2
  </details>
</div>

</div>
<div class="divider"></div><div class="ud-atom">
  <h3></h3>
  <div>
  <form>
    <fieldset>
      <legend><p>Which of the following are true?</p></legend>
    </fieldset>

    <div>
      <input type="checkbox" value="a1587286175998" name="1015010" id="a1587286175998">
      <label for="a1587286175998"><p>The DenseVariational layer is a special Keras layer that uses a Python lambda to construct a distribution based on the layer inputs and the output of the final layer of the model is passed into the loss function</p></label>
    </div>
    <div>
      <input type="checkbox" value="a1587286184491" name="1015010" id="a1587286184491">
      <label for="a1587286184491"><p>The VariableGaussianProcess layer can be used when you do not know the relationship between the label and the data.</p></label>
    </div>
    <div>
      <input type="checkbox" value="a1587286185593" name="1015010" id="a1587286185593">
      <label for="a1587286185593"><p>If we use MSE the scale or standard deviation will not be fixed.</p></label>
    </div>
    <div>
      <input type="checkbox" value="a1587286186600" name="1015010" id="a1587286186600">
      <label for="a1587286186600"><p>For epistemic uncertainty, the 'posterior_mean_field' and 'prior_trainable' functions are added as arguments to the DenseVariational layer.</p></label>
    </div>
  </form>

  <details>
    <summary><strong>SOLUTION:</strong></summary>
    <ul>
      <li>The VariableGaussianProcess layer can be used when you do not know the relationship between the label and the data.</li>
      <li>For epistemic uncertainty, the 'posterior_mean_field' and 'prior_trainable' functions are added as arguments to the DenseVariational layer.</li>
  </ul>
  </details>
</div>

</div>
<div class="divider"></div>
          </div>

          <div class="col-12">
            <p class="text-right">
              <a href="13. Uncertainty Estimation Exercise.html" class="btn btn-outline-primary mt-4" role="button">Next Concept</a>
            </p>
          </div>
        </div>
      </main>

      <footer class="footer">
        <div class="container">
          <div class="row">
            <div class="col-12">
              <p class="text-center">
                <a href="https://us-udacity.github.io/" target="_blank">【udacity2.0 】If you need more courses, please add wechat：udacity6</a>
              </p>
            </div>
          </div>
        </div>
      </footer>
    </div>
  </div>


  <script src="../assets/js/jquery-3.3.1.min.js"></script>
  <script src="../assets/js/plyr.polyfilled.min.js"></script>
  <script src="../assets/js/bootstrap.min.js"></script>
  <script src="../assets/js/jquery.mCustomScrollbar.concat.min.js"></script>
  <script src="../assets/js/katex.min.js"></script>
  <script>
    // Initialize Plyr video players
    const players = Array.from(document.querySelectorAll('video')).map(p => new Plyr(p));

    // render math equations
    let elMath = document.getElementsByClassName('mathquill');
    for (let i = 0, len = elMath.length; i < len; i += 1) {
      const el = elMath[i];

      katex.render(el.textContent, el, {
        throwOnError: false
      });
    }

    // this hack will make sure Bootstrap tabs work when using Handlebars
    if ($('#question-tabs').length && $('#user-answer-tabs').length) {
      $("#question-tabs a.nav-link").on('click', function () {
        $("#question-tab-contents .tab-pane").hide();
        $($(this).attr("href")).show();
      });
      $("#user-answer-tabs a.nav-link").on('click', function () {
        $("#user-answer-tab-contents .tab-pane").hide();
        $($(this).attr("href")).show();
      });
    } else {
      $("a.nav-link").on('click', function () {
        $(".tab-pane").hide();
        $($(this).attr("href")).show();
      });
    }

    // side bar events
    $(document).ready(function () {
      $("#sidebar").mCustomScrollbar({
        theme: "minimal"
      });

      $('#sidebarCollapse').on('click', function () {
        $('#sidebar, #content').toggleClass('active');
        $('.collapse.in').toggleClass('in');
        $('a[aria-expanded=true]').attr('aria-expanded', 'false');
      });

      // scroll to first video on page loading
      if ($('video').length) {
        $('html,body').animate({ scrollTop: $('div.plyr').prev().offset().top});
      }

      // auto play first video: this may not work with chrome/safari due to autoplay policy
      if (players && players.length > 0) {
        players[0].play();
      }

      // scroll sidebar to current concept
      const currentInSideBar = $( "ul.sidebar-list.components li a:contains('12. Train Uncertainty Estimation Model Walkthrough')" )
      currentInSideBar.css( "text-decoration", "underline" );
      $("#sidebar").mCustomScrollbar('scrollTo', currentInSideBar);
    });
  </script>
</body>

</html>
